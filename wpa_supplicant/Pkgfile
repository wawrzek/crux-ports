# Description: User space IEEE 802.1X/WPA supplicant (wireless client)
# URL:         http://hostap.epitest.fi/wpa_supplicant/
# Maintainer: Wawrzek Niewodniczanski, main at wawrzek dot name
# Packager:  Juergen Daubert, jue at crux dot nu
# Depends on:  openssl ncurses readline libnl dbus

name=wpa_supplicant
version=2.6
release=4
source=(http://https://w1.fi/releases/$name-$version.tar.gz
        wpa_supplicant
        rebased-v2.6-0001-hostapd-Avoid-key-reinstallation-in-FT-handshake.patch
        rebased-v2.6-0002-Prevent-reinstallation-of-an-already-in-use-group-ke.patch
        rebased-v2.6-0003-Extend-protection-of-GTK-IGTK-reinstallation-of-WNM-.patch
        rebased-v2.6-0004-Prevent-installation-of-an-all-zero-TK.patch
        rebased-v2.6-0005-Fix-PTK-rekeying-to-generate-a-new-ANonce.patch
        rebased-v2.6-0006-TDLS-Reject-TPK-TK-reconfiguration.patch
        rebased-v2.6-0007-WNM-Ignore-WNM-Sleep-Mode-Response-without-pending-r.patch
        rebased-v2.6-0008-FT-Do-not-allow-multiple-Reassociation-Response-fram.patch
        wlan)

build () {
    cd $name-$version/$name

    patch -d.. -p1 -i $SRC/rebased-v2.6-0001-hostapd-Avoid-key-reinstallation-in-FT-handshake.patch
    patch -d.. -p1 -i $SRC/rebased-v2.6-0002-Prevent-reinstallation-of-an-already-in-use-group-ke.patch
    patch -d.. -p1 -i $SRC/rebased-v2.6-0003-Extend-protection-of-GTK-IGTK-reinstallation-of-WNM-.patch
    patch -d.. -p1 -i $SRC/rebased-v2.6-0004-Prevent-installation-of-an-all-zero-TK.patch
    patch -d.. -p1 -i $SRC/rebased-v2.6-0005-Fix-PTK-rekeying-to-generate-a-new-ANonce.patch
    patch -d.. -p1 -i $SRC/rebased-v2.6-0006-TDLS-Reject-TPK-TK-reconfiguration.patch
    patch -d.. -p1 -i $SRC/rebased-v2.6-0007-WNM-Ignore-WNM-Sleep-Mode-Response-without-pending-r.patch
    patch -d.. -p1 -i $SRC/rebased-v2.6-0008-FT-Do-not-allow-multiple-Reassociation-Response-fram.patch

    cp defconfig .config
    echo "CONFIG_READLINE=y
          CONFIG_LIBNL32=y
          CONFIG_DEBUG_SYSLOG=y
          CONFIG_BGSCAN_SIMPLE=y
          CONFIG_AP=y
          CONFIG_WPS=y
          CONFIG_CTRL_IFACE_DBUS_NEW=y
          CFLAGS+=-I/usr/include/libnl3" >> .config

    make BINDIR=/usr/sbin LIBDIR=/usr/lib

    install -d $PKG/{usr/sbin,usr/man/man{8,5},etc}
    install -m 0755 wpa_{cli,passphrase,supplicant} $PKG/usr/sbin
    install -m 0644 doc/docbook/wpa_{background,cli,passphrase,supplicant}.8 $PKG/usr/man/man8
    install -m 0644 doc/docbook/wpa_supplicant.conf.5 $PKG/usr/man/man5

    # config
    echo -e "ctrl_interface=/var/run/wpa_supplicant\n" > $PKG/etc/wpa_supplicant.conf
    chmod 0600 $PKG/etc/wpa_supplicant.conf

    # rc script
    install -D -m 0755 $SRC/wpa_supplicant $PKG/etc/rc.d/wpa_supplicant

    # dbus
    install -d $PKG/usr/{share/dbus-1/system-services,etc/dbus-1/system.d}
    install -m 0644 dbus/fi.w1.wpa_supplicant1.service $PKG/usr/share/dbus-1/system-services/
    install -m 0644 dbus/dbus-wpa_supplicant.conf $PKG/usr/etc/dbus-1/system.d/wpa_supplicant.conf
}
